<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demand Rusher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c2f33;
            color: #dcdcdc;
        }
        .container-panel {
            background-color: #40444b;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .offer-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #36393f;
        }
        .offer-row:last-child {
            border-bottom: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-[#2c2f33] min-h-screen flex flex-col items-center">

    <div class="w-full max-w-5xl p-8 space-y-8">

        <!-- Updated Header with Log Off Button -->
        <header class="flex justify-between items-center container-panel p-6 relative">
            <div class="flex-grow flex flex-col items-center">
                <h1 class="text-4xl font-bold text-[#7289da]">Demand Rusher</h1>
                <nav class="flex-grow flex justify-center space-x-4 mt-4">
                    <button data-view="market" class="tab-button bg-[#36393f] text-[#dcdcdc] font-bold py-2 px-6 rounded-md hover:bg-[#4a4d53] transition duration-200">
                        Market
                    </button>
                    <button data-view="inventory" class="tab-button bg-[#36393f] text-[#dcdcdc] font-bold py-2 px-6 rounded-md hover:bg-[#4a4d53] transition duration-200">
                        Inventory
                    </button>
                    <button data-view="crafting" class="tab-button bg-[#36393f] text-[#dcdcdc] font-bold py-2 px-6 rounded-md hover:bg-[#4a4d53] transition duration-200">
                        Crafting
                    </button>
                    <button data-view="jobs" class="tab-button bg-[#36393f] text-[#dcdcdc] font-bold py-2 px-6 rounded-md hover:bg-[#4a4d53] transition duration-200">
                        Job Offers
                    </button>
                    <button data-view="ranking" class="tab-button bg-[#36393f] text-[#dcdcdc] font-bold py-2 px-6 rounded-md hover:bg-[#4a4d53] transition duration-200">
                        Ranking
                    </button>
                </nav>
            </div>
            <div class="absolute top-4 right-4 flex items-center space-x-2">
                <button id="gamemaster-btn" class="bg-[#f04747] text-white font-bold py-2 px-4 rounded-full hover:bg-[#c93d3d] transition duration-200 hidden">
                    GameMaster Mode
                </button>
                <!-- Gearwheel icon button -->
                <button id="settings-btn" class="text-2xl text-[#dcdcdc] hover:text-[#7289da] transition duration-200">
                    ⚙️
                </button>
                <!-- Log Off dropdown menu -->
                <div id="settings-menu" class="absolute top-12 right-0 bg-[#40444b] rounded-md shadow-lg py-1 hidden z-10">
                    <button id="logoff-btn" class="w-full text-left px-4 py-2 text-sm text-[#dcdcdc] hover:bg-[#52555a] transition duration-200">
                        Log Off
                    </button>
                </div>
            </div>
        </header>

        <div class="main-content flex-grow p-4">

            <div class="container-panel p-4 flex flex-col md:flex-row justify-between items-center mb-4">
                <div class="text-lg font-semibold">
                    User: <span id="user-name">Loading...</span>
                </div>
                <div class="text-lg font-semibold mt-2 md:mt-0">
                    Balance: <span id="player-balance" class="text-green-400">$0.00</span>
                </div>
            </div>

            <div id="market-view" class="tab-content active">
                <div class="container-panel p-4 space-y-4">
                    <h2 class="text-xl font-bold mb-2">Marketplace</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Sell Offers</h3>
                            <div class="offer-header-row font-bold text-sm text-gray-400 border-b border-[#36393f] pb-2 grid grid-cols-6 gap-2">
                                <span>Item</span>
                                <span>Quantity</span>
                                <span>Price/Unit</span>
                                <span>Total Price</span>
                                <span>Seller</span>
                                <span>Action</span>
                            </div>
                            <div id="sell-offers-list" class="offer-list mt-2 space-y-1">
                                <p class="text-center text-gray-500">No sell offers available.</p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-2">Buy Offers</h3>
                            <div class="offer-header-row font-bold text-sm text-gray-400 border-b border-[#36393f] pb-2 grid grid-cols-6 gap-2">
                                <span>Item</span>
                                <span>Quantity</span>
                                <span>Price/Unit</span>
                                <span>Total Price</span>
                                <span>Buyer</span>
                                <span>Action</span>
                            </div>
                            <div id="buy-offers-list" class="offer-list mt-2 space-y-1">
                                <p class="text-center text-gray-500">No buy offers available.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="container-panel p-4 mt-8">
                        <h3 class="text-lg font-semibold mb-4">Create New Offer</h3>
                        <form id="create-offer-form" class="space-y-4">
                            <div>
                                <label for="item-select" class="block text-sm font-medium mb-1">Item to Sell</label>
                                <select id="item-select" class="w-full p-2 bg-[#2f3136] rounded-md focus:outline-none focus:ring-1 focus:ring-[#7289da]"></select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="quantity-input" class="block text-sm font-medium mb-1">Quantity</label>
                                    <input type="number" id="quantity-input" min="1" required class="w-full p-2 bg-[#2f3136] rounded-md focus:outline-none focus:ring-1 focus:ring-[#7289da]">
                                </div>
                                <div>
                                    <label for="price-input" class="block text-sm font-medium mb-1">Price per Unit</label>
                                    <input type="number" id="price-input" min="1" required class="w-full p-2 bg-[#2f3136] rounded-md focus:outline-none focus:ring-1 focus:ring-[#7289da]">
                                </div>
                                <div>
                                    <label for="offer-type-select" class="block text-sm font-medium mb-1">Offer Type</label>
                                    <select id="offer-type-select" class="w-full p-2 bg-[#2f3136] rounded-md focus:outline-none focus:ring-1 focus:ring-[#7289da]">
                                        <option value="sell">Sell</option>
                                        <option value="buy">Buy</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-right text-sm text-gray-400">
                                <span id="commission-info"></span>
                            </div>
                            <div class="text-right text-lg font-bold">
                                Total: <span id="total-price-info" class="text-green-400">$0.00</span>
                            </div>
                            <button type="submit" class="w-full bg-[#7289da] text-white font-bold py-2 px-4 rounded-md hover:bg-[#6273c5] transition duration-200">Create Offer</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="inventory-view" class="tab-content">
                <div class="container-panel p-4">
                    <h2 class="text-xl font-bold mb-2">My Inventory</h2>
                    <div id="inventory-list" class="space-y-2">
                        <p class="text-center text-gray-500">Inventory is empty.</p>
                    </div>
                </div>
            </div>

            <div id="crafting-view" class="tab-content">
                <div class="container-panel p-4">
                    <h2 class="text-xl font-bold mb-2">Crafting Station</h2>
                    <p class="text-gray-400">This section is under construction. It will allow you to combine items to create new ones.</p>
                </div>
            </div>

            <div id="ranking-view" class="tab-content">
                <div class="container-panel p-4 space-y-4">
                    <h2 class="text-xl font-bold mb-2">Player Rankings</h2>
                    <div class="flex space-x-4">
                        <button id="rank-by-money-btn" class="bg-[#7289da] text-white font-bold py-2 px-6 rounded-md hover:bg-[#6273c5] transition duration-200">
                            Rank by Money
                        </button>
                        <button id="rank-by-xp-btn" class="bg-[#36393f] text-[#dcdcdc] font-bold py-2 px-6 rounded-md hover:bg-[#4a4d53] transition duration-200">
                            Rank by Experience
                        </button>
                    </div>
                    <div id="ranking-list" class="space-y-2">
                        <p class="text-center text-gray-500">Loading rankings...</p>
                    </div>
                </div>
            </div>

            <div id="jobs-view" class="tab-content">
                <div class="container-panel p-4">
                    <h2 class="text-xl font-bold mb-2">Job Board</h2>
                    <p class="text-gray-400">This section is under construction. Check back later for new quests and jobs!</p>
                </div>
            </div>

        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
        <div class="bg-[#36393f] rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-400 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="modal-ok-btn" class="bg-[#7289da] text-white font-bold py-2 px-4 rounded-full hover:bg-[#6273c5] transition duration-200">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // IMPORTANT: Paste your actual User ID here for testing purposes.
        const gameMasterId = 'fJ6c2jW6wR9TqZ8sL4pA';

        // Global variables for Firebase and app state
        let app;
        let db;
        let auth;
        let userId;

        // --- DOM References ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const userNameSpan = document.getElementById('user-name');
        const playerBalanceSpan = document.getElementById('player-balance');
        const inventoryList = document.getElementById('inventory-list');
        const sellOffersList = document.getElementById('sell-offers-list');
        const buyOffersList = document.getElementById('buy-offers-list');
        const createOfferForm = document.getElementById('create-offer-form');
        const offerTypeSelect = document.getElementById('offer-type-select');
        const itemSelect = document.getElementById('item-select');
        const quantityInput = document.getElementById('quantity-input');
        const priceInput = document.getElementById('price-input');
        const totalPriceInfo = document.getElementById('total-price-info');
        const commissionInfo = document.getElementById('commission-info');
        const gamemasterBtn = document.getElementById('gamemaster-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        // New DOM References
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const logoffBtn = document.getElementById('logoff-btn');


        // --- Global Data Storage ---
        let playerInventory = {};
        let playerBalance = 0;
        let playerItems = {};
        let sellOffers = [];
        let buyOffers = [];
        let itemsMetadata = {};

        // Ranking global variables and DOM references
        const rankingListEl = document.getElementById('ranking-list');
        const rankByMoneyBtn = document.getElementById('rank-by-money-btn');
        const rankByXpBtn = document.getElementById('rank-by-xp-btn');
        let allPlayersData = [];

        // --- Firestore Initialization & Listeners ---
        async function initializeFirestore() {
            const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/data`);
            const playerDoc = await getDoc(playerDocRef);
            
            if (!playerDoc.exists()) {
                // Initialize new player state
                await setDoc(playerDocRef, {
                    balance: 50000,
                    name: `Player_${userId.slice(0, 4)}`,
                    experience: 0
                });
                playerBalance = 50000;
                // Add initial inventory
                const initialInventoryRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
                await setDoc(initialInventoryRef, {
                    'item_wood': 10,
                    'item_ore': 5,
                    'item_food': 3
                });
                playerInventory = {
                    'item_wood': 10,
                    'item_ore': 5,
                    'item_food': 3
                };
            } else {
                const data = playerDoc.data() || {};
                playerBalance = data.balance || 0;
            }

            // Get player's inventory
            const playerInventoryRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
            const inventoryDoc = await getDoc(playerInventoryRef);
            playerInventory = inventoryDoc.exists() ? inventoryDoc.data() : {};


            // Get all items metadata once
            const itemsCollection = collection(db, `artifacts/${appId}/items`);
            const itemsSnapshot = await getDocs(itemsCollection);
            itemsSnapshot.forEach(doc => {
                itemsMetadata[doc.id] = doc.data();
            });

            // Populate item dropdown in create offer form
            populateItemDropdown();
        }

        function setupFirestoreListeners() {
            // Listen for changes to the player's document
            const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/data`);
            onSnapshot(playerDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data() || {};
                    playerBalance = data.balance || 0;
                    updateUI();
                }
            });

            const playerInventoryRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
            onSnapshot(playerInventoryRef, (doc) => {
                if (doc.exists()) {
                    playerInventory = doc.data() || {};
                    updateUI();
                }
            });

            // Listen for changes to market offers
            const offersCollectionRef = collection(db, `artifacts/${appId}/offers`);
            onSnapshot(offersCollectionRef, (snapshot) => {
                sellOffers = [];
                buyOffers = [];
                snapshot.forEach(doc => {
                    const offer = { id: doc.id, ...doc.data() };
                    if (offer.type === 'sell') {
                        sellOffers.push(offer);
                    } else if (offer.type === 'buy') {
                        buyOffers.push(offer);
                    }
                });
                renderOffers();
            });

            const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
            onSnapshot(usersCollectionRef, (snapshot) => {
                allPlayersData = snapshot.docs.map(doc => {
                    const data = doc.data().playerState.data;
                    const items = doc.data().playerState.items;
                    return { uid: doc.id, ...data, ...items };
                });
                renderRanking('balance'); // Default to ranking by money
            });
        }

        function renderRanking(sortBy) {
            let sortedPlayers = [];
            if (sortBy === 'balance') {
                sortedPlayers = [...allPlayersData].sort((a, b) => (b.balance || 0) - (a.balance || 0));
            } else if (sortBy === 'experience') {
                sortedPlayers = [...allPlayersData].sort((a, b) => (b.experience || 0) - (a.experience || 0));
            }

            rankingListEl.innerHTML = '';
            if (sortedPlayers.length === 0) {
                rankingListEl.innerHTML = '<p class="text-center text-gray-500">No players found to rank.</p>';
            } else {
                sortedPlayers.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'bg-[#36393f] p-4 rounded-md shadow-md flex justify-between items-center';
                    playerDiv.innerHTML = `
                        <span class="font-bold text-[#7289da]">#${index + 1}</span>
                        <span class="font-semibold">${player.name || player.uid.slice(0, 8) + '...'}</span>
                        <span>Money: <span class="text-green-400">$${(player.balance || 0).toFixed(2)}</span></span>
                        <span>Experience: ${player.experience || 0} XP</span>
                    `;
                    rankingListEl.appendChild(playerDiv);
                });
            }
        }

        // Event listeners for ranking buttons
        rankByMoneyBtn.addEventListener('click', () => {
            renderRanking('balance');
            rankByMoneyBtn.classList.add('bg-[#7289da]', 'text-white');
            rankByMoneyBtn.classList.remove('bg-[#36393f]', 'text-[#dcdcdc]');
            rankByXpBtn.classList.remove('bg-[#7289da]', 'text-white');
            rankByXpBtn.classList.add('bg-[#36393f]', 'text-[#dcdcdc]');
        });

        rankByXpBtn.addEventListener('click', () => {
            renderRanking('experience');
            rankByXpBtn.classList.add('bg-[#7289da]', 'text-white');
            rankByXpBtn.classList.remove('bg-[#36393f]', 'text-[#dcdcdc]');
            rankByMoneyBtn.classList.remove('bg-[#7289da]', 'text-white');
            rankByMoneyBtn.classList.add('bg-[#36393f]', 'text-[#dcdcdc]');
        });


        // --- UI Rendering Functions ---
        function updateUI() {
            // Get the user's name from playerInventory
            const playerName = playerItems.name;
            if (playerName) {
                userNameSpan.textContent = playerName;
            } else {
                userNameSpan.textContent = auth.currentUser.displayName || auth.currentUser.uid.slice(0, 8);
            }
            playerBalanceSpan.textContent = `$${playerBalance.toFixed(2)}`;
            renderInventory();
            populateItemDropdown();
        }

        function showView(viewName) {
            tabContents.forEach(view => view.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');

            tabButtons.forEach(button => {
                button.classList.remove('bg-[#7289da]', 'text-white');
                button.classList.add('bg-[#36393f]', 'text-[#dcdcdc]');
                if (button.dataset.view === viewName) {
                    button.classList.add('bg-[#7289da]', 'text-white');
                    button.classList.remove('bg-[#36393f]', 'text-[#dcdcdc]');
                }
            });
        }

        function renderInventory() {
            inventoryList.innerHTML = '';
            const items = Object.keys(playerInventory);
            if (items.length === 0) {
                inventoryList.innerHTML = '<p class="text-center text-gray-500">Inventory is empty.</p>';
            } else {
                items.forEach(itemId => {
                    const quantity = playerInventory[itemId];
                    if (quantity > 0) {
                        const itemMetadata = itemsMetadata[itemId] || { name: 'Unknown Item' };
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-[#36393f] p-4 rounded-md shadow-md flex justify-between items-center';
                        itemDiv.innerHTML = `
                            <span class="font-semibold">${itemMetadata.name}</span>
                            <span>x${quantity}</span>
                        `;
                        inventoryList.appendChild(itemDiv);
                    }
                });
            }
        }

        function renderOffers() {
            // Render Sell Offers
            sellOffersList.innerHTML = '';
            if (sellOffers.length === 0) {
                sellOffersList.innerHTML = '<p class="text-center text-gray-500">No sell offers available.</p>';
            } else {
                sellOffers.forEach(offer => {
                    const itemMetadata = itemsMetadata[offer.itemId] || { name: 'Unknown Item' };
                    const offerRow = document.createElement('div');
                    offerRow.className = 'offer-row hover:bg-[#4a4d53] rounded-md transition duration-200';
                    const isMyOffer = offer.sellerId === userId;
                    const actionBtn = isMyOffer
                        ? `<button class="action-btn bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600" data-offer-id="${offer.id}">Cancel</button>`
                        : `<button class="action-btn bg-[#7289da] text-white py-1 px-3 rounded-md text-sm hover:bg-[#6273c5]" data-offer-id="${offer.id}">Buy</button>`;

                    offerRow.innerHTML = `
                        <span>${itemMetadata.name}</span>
                        <span>x${offer.quantity}</span>
                        <span>$${offer.pricePerUnit.toFixed(2)}</span>
                        <span>$${(offer.quantity * offer.pricePerUnit).toFixed(2)}</span>
                        <span>${isMyOffer ? 'You' : offer.sellerId.slice(0, 8)}...</span>
                        <span>${actionBtn}</span>
                    `;
                    sellOffersList.appendChild(offerRow);
                });
                attachOfferListeners();
            }

            // Render Buy Offers
            buyOffersList.innerHTML = '';
            if (buyOffers.length === 0) {
                buyOffersList.innerHTML = '<p class="text-center text-gray-500">No buy offers available.</p>';
            } else {
                buyOffers.forEach(offer => {
                    const itemMetadata = itemsMetadata[offer.itemId] || { name: 'Unknown Item' };
                    const offerRow = document.createElement('div');
                    offerRow.className = 'offer-row hover:bg-[#4a4d53] rounded-md transition duration-200';
                    const isMyOffer = offer.buyerId === userId;
                    const actionBtn = isMyOffer
                        ? `<button class="action-btn bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600" data-offer-id="${offer.id}">Cancel</button>`
                        : `<button class="action-btn bg-[#7289da] text-white py-1 px-3 rounded-md text-sm hover:bg-[#6273c5]" data-offer-id="${offer.id}">Sell</button>`;

                    offerRow.innerHTML = `
                        <span>${itemMetadata.name}</span>
                        <span>x${offer.quantity}</span>
                        <span>$${offer.pricePerUnit.toFixed(2)}</span>
                        <span>$${(offer.quantity * offer.pricePerUnit).toFixed(2)}</span>
                        <span>${isMyOffer ? 'You' : offer.buyerId.slice(0, 8)}...</span>
                        <span>${actionBtn}</span>
                    `;
                    buyOffersList.appendChild(offerRow);
                });
                attachOfferListeners();
            }
        }

        function populateItemDropdown() {
            itemSelect.innerHTML = '';
            Object.keys(playerInventory).forEach(itemId => {
                if (playerInventory[itemId] > 0) {
                    const itemMetadata = itemsMetadata[itemId] || { name: 'Unknown Item' };
                    const option = document.createElement('option');
                    option.value = itemId;
                    option.textContent = itemMetadata.name;
                    itemSelect.appendChild(option);
                }
            });
        }

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }

        // --- Transaction and Game Logic ---
        async function buyFromOffer(offerId) {
            const offerRef = doc(db, `artifacts/${appId}/offers/${offerId}`);
            const buyerDataRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/data`);
            const buyerItemsRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const offerDoc = await transaction.get(offerRef);
                    const buyerDataDoc = await transaction.get(buyerDataRef);
                    const buyerItemsDoc = await transaction.get(buyerItemsRef);

                    if (!offerDoc.exists() || !buyerDataDoc.exists() || !buyerItemsDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const offer = offerDoc.data();
                    const buyerStateData = buyerDataDoc.data();
                    const buyerStateItems = buyerItemsDoc.data();
                    const totalCost = offer.quantity * offer.pricePerUnit;

                    if (buyerStateData.balance < totalCost) {
                        throw "Not enough money to buy this item!";
                    }

                    // Update buyer's state
                    buyerStateData.balance -= totalCost;
                    const currentItemQuantity = buyerStateItems[offer.itemId] || 0;
                    buyerStateItems[offer.itemId] = currentItemQuantity + offer.quantity;
                    
                    transaction.update(buyerDataRef, buyerStateData);
                    transaction.update(buyerItemsRef, buyerStateItems);

                    // Update seller's state (if they still exist)
                    const sellerDataRef = doc(db, `artifacts/${appId}/users/${offer.sellerId}/playerState/data`);
                    const sellerDataDoc = await transaction.get(sellerDataRef);
                    if (sellerDataDoc.exists()) {
                        const sellerStateData = sellerDataDoc.data();
                        const commission = totalCost * 0.10;
                        sellerStateData.balance += (totalCost - commission);
                        transaction.update(sellerDataRef, sellerStateData);
                    }

                    // Delete the offer
                    transaction.delete(offerRef);
                });
                showModal('Success!', 'You have successfully bought the item.');
            } catch (e) {
                console.error("Transaction failed: ", e);
                showModal('Failed!', `Could not complete transaction: ${e}`);
            }
        }

        async function sellToOffer(offerId) {
            const offerRef = doc(db, `artifacts/${appId}/offers/${offerId}`);
            const sellerDataRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/data`);
            const sellerItemsRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const offerDoc = await transaction.get(offerRef);
                    const sellerDataDoc = await transaction.get(sellerDataRef);
                    const sellerItemsDoc = await transaction.get(sellerItemsRef);

                    if (!offerDoc.exists() || !sellerDataDoc.exists() || !sellerItemsDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const offer = offerDoc.data();
                    const sellerStateData = sellerDataDoc.data();
                    const sellerStateItems = sellerItemsDoc.data();
                    const totalCost = offer.quantity * offer.pricePerUnit;
                    const currentItemQuantity = sellerStateItems[offer.itemId] || 0;

                    if (currentItemQuantity < offer.quantity) {
                        throw "You don't have enough items to sell!";
                    }

                    // Update seller's state
                    sellerStateData.balance += totalCost;
                    sellerStateItems[offer.itemId] -= offer.quantity;
                    if (sellerStateItems[offer.itemId] <= 0) {
                        delete sellerStateItems[offer.itemId];
                    }
                    
                    transaction.update(sellerDataRef, sellerStateData);
                    transaction.update(sellerItemsRef, sellerStateItems);

                    // Update buyer's state (if they still exist)
                    const buyerDataRef = doc(db, `artifacts/${appId}/users/${offer.buyerId}/playerState/data`);
                    const buyerItemsRef = doc(db, `artifacts/${appId}/users/${offer.buyerId}/playerState/items`);
                    const buyerDataDoc = await transaction.get(buyerDataRef);
                    const buyerItemsDoc = await transaction.get(buyerItemsRef);

                    if (buyerDataDoc.exists() && buyerItemsDoc.exists()) {
                        const buyerStateData = buyerDataDoc.data();
                        const buyerStateItems = buyerItemsDoc.data();
                        const commission = totalCost * 0.10;
                        buyerStateData.balance -= (totalCost + commission);
                        buyerStateItems[offer.itemId] = (buyerStateItems[offer.itemId] || 0) + offer.quantity;

                        transaction.update(buyerDataRef, buyerStateData);
                        transaction.update(buyerItemsRef, buyerStateItems);
                    }

                    // Delete the offer
                    transaction.delete(offerRef);
                });
                showModal('Success!', 'You have successfully sold your item.');
            } catch (e) {
                console.error("Transaction failed: ", e);
                showModal('Failed!', `Could not complete transaction: ${e}`);
            }
        }

        async function cancelOffer(offerId) {
            const offerRef = doc(db, `artifacts/${appId}/offers/${offerId}`);
            const sellerDataRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/data`);
            const sellerItemsRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const offerDoc = await transaction.get(offerRef);
                    const sellerDataDoc = await transaction.get(sellerDataRef);
                    const sellerItemsDoc = await transaction.get(sellerItemsRef);

                    if (!offerDoc.exists() || !sellerDataDoc.exists() || !sellerItemsDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const offer = offerDoc.data();
                    const sellerStateData = sellerDataDoc.data();
                    const sellerStateItems = sellerItemsDoc.data();

                    if (offer.type === 'sell') {
                        sellerStateItems[offer.itemId] = (sellerStateItems[offer.itemId] || 0) + offer.quantity;
                        transaction.update(sellerItemsRef, sellerStateItems);
                    } else if (offer.type === 'buy') {
                        sellerStateData.balance += (offer.quantity * offer.pricePerUnit);
                        transaction.update(sellerDataRef, sellerStateData);
                    }

                    // Delete the offer
                    transaction.delete(offerRef);
                });
                showModal('Success!', 'Offer has been cancelled.');
            } catch (e) {
                console.error("Transaction failed: ", e);
                showModal('Error', 'Failed to cancel offer.');
            }
        }

        // --- Event Listeners ---
        modalOkBtn.addEventListener('click', hideModal);

        function attachOfferListeners() {
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.onclick = (event) => {
                    const offerId = event.target.dataset.offerId;
                    const offer = sellOffers.find(o => o.id === offerId) || buyOffers.find(o => o.id === offerId);
                    if (!offer) return;
                    
                    if (offer.type === 'sell' && offer.sellerId !== userId) {
                        buyFromOffer(offerId);
                    } else if (offer.type === 'buy' && offer.buyerId !== userId) {
                        sellToOffer(offerId);
                    } else if (offer.sellerId === userId || offer.buyerId === userId) {
                        cancelOffer(offerId);
                    }
                };
            });
        }

        createOfferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = itemSelect.value;
            const quantity = parseInt(quantityInput.value);
            const pricePerUnit = parseFloat(priceInput.value);
            const offerType = offerTypeSelect.value;

            if (isNaN(quantity) || isNaN(pricePerUnit) || quantity <= 0 || pricePerUnit <= 0) {
                showModal('Invalid Input', 'Please enter valid positive numbers for quantity and price.');
                return;
            }

            if (playerInventory[itemId] < quantity && offerType === 'sell') {
                showModal('Invalid Quantity', 'You do not have enough of this item to sell.');
                return;
            }

            const totalValue = quantity * pricePerUnit;
            if (playerBalance < totalValue && offerType === 'buy') {
                showModal('Not Enough Money', 'You do not have enough money to place this buy offer.');
                return;
            }

            const offersCollectionRef = collection(db, `artifacts/${appId}/offers`);
            const offer = {
                itemId: itemId,
                quantity: quantity,
                pricePerUnit: pricePerUnit,
                type: offerType,
                timestamp: Date.now(),
                sellerId: offerType === 'sell' ? userId : null,
                buyerId: offerType === 'buy' ? userId : null
            };

            // Deduct items for sell offer or money for buy offer
            const playerItemsRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/items`);
            const playerMoneyRef = doc(db, `artifacts/${appId}/users/${userId}/playerState/data`);

            try {
                await runTransaction(db, async (transaction) => {
                    const itemsDoc = await transaction.get(playerItemsRef);
                    const moneyDoc = await transaction.get(playerMoneyRef);
                    const currentItems = itemsDoc.data();
                    const currentMoney = moneyDoc.data();

                    if (offerType === 'sell') {
                        currentItems[itemId] -= quantity;
                        if (currentItems[itemId] === 0) {
                            delete currentItems[itemId];
                        }
                        transaction.update(playerItemsRef, currentItems);
                    } else if (offerType === 'buy') {
                        currentMoney.balance -= totalValue;
                        transaction.update(playerMoneyRef, currentMoney);
                    }
                    await addDoc(offersCollectionRef, offer);
                });
                showModal('Success', 'Your offer has been created!');
                createOfferForm.reset();
            } catch (e) {
                 showModal('Failed', `Could not create offer: ${e}`);
            }
        });

        priceInput.addEventListener('input', () => {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const type = offerTypeSelect.value;
            const total = quantity * price;

            if (type === 'sell') {
                const commission = total * 0.1;
                commissionInfo.textContent = `Commission (10%): $${commission.toFixed(2)}`;
                totalPriceInfo.textContent = `$${(total - commission).toFixed(2)}`;
            } else {
                commissionInfo.textContent = '';
                totalPriceInfo.textContent = `$${total.toFixed(2)}`;
            }
        });

        quantityInput.addEventListener('input', () => {
            priceInput.dispatchEvent(new Event('input'));
        });

        offerTypeSelect.addEventListener('change', () => {
            priceInput.dispatchEvent(new Event('input'));
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showView(button.dataset.view);
            });
        });

        gamemasterBtn.addEventListener('click', () => {
            window.open('gamemaster_panel.html', '_blank');
        });

        // New Event Listeners for settings and log off
        settingsBtn.addEventListener('click', (e) => {
            // This is the key part: stop the click event from bubbling up to the document listener
            e.stopPropagation();
            // Toggle the visibility of the settings menu
            settingsMenu.classList.toggle('hidden');
        });

        logoffBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'login.html';
        });

        // Close settings menu if user clicks outside
        document.addEventListener('click', (e) => {
            // Check if the click was outside of both the menu and the button
            if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsMenu.classList.add('hidden');
            }
        });

        // --- App Initialization ---
        window.onload = function() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    userId = user.uid;
                    if (userId === gameMasterId) {
                        gamemasterBtn.classList.remove('hidden');
                    }
                    await initializeFirestore();
                    setupFirestoreListeners();
                    updateUI();
                    showView('market');
                } else {
                    window.location.href = 'login.html';
                }
            });
        };
    </script>
</body>
</html>
