<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DemandRusher - Market</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">DemandRusher Market</h1>
    <div class="flex space-x-6 items-center">
      <span>User: <span id="user-name">Loading...</span></span>
      <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Logout</button>
      <button id="gamemaster-btn" class="hidden bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">Game Master Panel</button>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 p-4 grid grid-cols-3 gap-4">

    <!-- Player Info -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-bold mb-2">Your Stats</h2>
      <p>Money: <span id="player-money">0</span></p>
      <p>XP: <span id="player-xp">0</span></p>
      <h3 class="text-lg font-bold mt-4">Inventory</h3>
      <ul id="inventory-list" class="list-disc pl-5"></ul>
    </section>

    <!-- Market -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-bold mb-2">Market Offers</h2>
      <button id="create-offer-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded mb-4">Create Offer</button>
      <div>
        <h3 class="text-lg font-bold">Buy Offers</h3>
        <ul id="buy-offers-list" class="list-disc pl-5"></ul>
      </div>
      <div class="mt-4">
        <h3 class="text-lg font-bold">Sell Offers</h3>
        <ul id="sell-offers-list" class="list-disc pl-5"></ul>
      </div>
    </section>

    <!-- Ranking -->
    <section class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-bold mb-2">Ranking</h2>
      <div class="flex space-x-2 mb-2">
        <button id="sort-money" class="bg-gray-700 px-2 py-1 rounded">By Money</button>
        <button id="sort-xp" class="bg-gray-700 px-2 py-1 rounded">By XP</button>
      </div>
      <ol id="ranking-list" class="list-decimal pl-5"></ol>
    </section>
  </main>

  <!-- Create Offer Modal -->
  <div id="offer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
    <div class="bg-gray-800 p-6 rounded shadow w-96">
      <h2 class="text-xl font-bold mb-4">Create Offer</h2>
      <label class="block mb-2">Item:
        <input type="text" id="offer-item" class="w-full p-2 text-black rounded"/>
      </label>
      <label class="block mb-2">Quantity:
        <input type="number" id="offer-quantity" class="w-full p-2 text-black rounded"/>
      </label>
      <label class="block mb-2">Price:
        <input type="number" id="offer-price" class="w-full p-2 text-black rounded"/>
      </label>
      <label class="block mb-2">Type:
        <select id="offer-type" class="w-full p-2 text-black rounded">
          <option value="buy">Buy</option>
          <option value="sell">Sell</option>
        </select>
      </label>
      <div class="flex justify-end space-x-2 mt-4">
        <button id="cancel-offer-btn" class="bg-gray-600 px-4 py-2 rounded">Cancel</button>
        <button id="submit-offer-btn" class="bg-green-500 px-4 py-2 rounded">Create</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, onSnapshot, runTransaction 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    /* ---------------- Firebase Init ---------------- */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ---------------- DOM Elements ---------------- */
    const userNameSpan = document.getElementById("user-name");
    const logoutBtn = document.getElementById("logout-btn");
    const gamemasterBtn = document.getElementById("gamemaster-btn");
    const playerMoney = document.getElementById("player-money");
    const playerXp = document.getElementById("player-xp");
    const inventoryList = document.getElementById("inventory-list");
    const buyOffersList = document.getElementById("buy-offers-list");
    const sellOffersList = document.getElementById("sell-offers-list");
    const rankingList = document.getElementById("ranking-list");
    const offerModal = document.getElementById("offer-modal");
    const offerItem = document.getElementById("offer-item");
    const offerQuantity = document.getElementById("offer-quantity");
    const offerPrice = document.getElementById("offer-price");
    const offerType = document.getElementById("offer-type");
    const cancelOfferBtn = document.getElementById("cancel-offer-btn");
    const submitOfferBtn = document.getElementById("submit-offer-btn");

    /* ---------------- Auth State ---------------- */
    let currentUserId = null;
    const gameMasterId = "GAME_MASTER_UID"; // to be replaced with real GM UID

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        // Show GM button only for gamemaster
        if (user.uid === gameMasterId) {
          gamemasterBtn.classList.remove("hidden");
        }
        // Show nickname instead of UID
        const playerRef = doc(db, "playerState", user.uid);
        const snap = await getDoc(playerRef);
        if (snap.exists()) {
          userNameSpan.textContent = snap.data().nickname || user.uid.slice(0, 8);
        } else {
          userNameSpan.textContent = user.uid.slice(0, 8);
        }
        loadPlayerState();
        loadOffers();
        loadRanking();
      } else {
        window.location.href = "login.html";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    gamemasterBtn.addEventListener("click", () => {
      window.location.href = "gamemaster_panel.html";
    });

    /* ---------------- Load Player State ---------------- */
    async function loadPlayerState() {
      const ref = doc(db, "playerState", currentUserId);
      onSnapshot(ref, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          playerMoney.textContent = data.money ?? 0;
          playerXp.textContent = data.xp ?? 0;
          inventoryList.innerHTML = "";
          if (data.inventory) {
            for (const [item, qty] of Object.entries(data.inventory)) {
              const li = document.createElement("li");
              li.textContent = `${item}: ${qty}`;
              inventoryList.appendChild(li);
            }
          }
        }
      });
    }

    /* ---------------- Offers ---------------- */
    function loadOffers() {
      const q = query(collection(db, "offers"));
      onSnapshot(q, (snapshot) => {
        buyOffersList.innerHTML = "";
        sellOffersList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const offer = docSnap.data();
          const li = document.createElement("li");
          li.textContent = `${offer.item} x${offer.quantity} @ $${offer.price} (${offer.type})`;
          const btn = document.createElement("button");
          btn.className = "ml-2 bg-blue-500 px-2 py-1 rounded";
          btn.textContent = "Trade";
          btn.onclick = () => handleTrade(docSnap.id, offer);
          li.appendChild(btn);
          if (offer.type === "buy") {
            buyOffersList.appendChild(li);
          } else {
            sellOffersList.appendChild(li);
          }
        });
      });
    }

    async function handleTrade(offerId, offer) {
      const offerRef = doc(db, "offers", offerId);
      const buyerRef = doc(db, "playerState", currentUserId);
      const sellerRef = doc(db, "playerState", offer.userId);

      await runTransaction(db, async (transaction) => {
        const offerSnap = await transaction.get(offerRef);
        if (!offerSnap.exists()) throw "Offer no longer exists";

        const buyerSnap = await transaction.get(buyerRef);
        const sellerSnap = await transaction.get(sellerRef);

        if (!buyerSnap.exists() || !sellerSnap.exists()) throw "User state missing";

        const buyer = buyerSnap.data();
        const seller = sellerSnap.data();
        const item = offer.item;

        if (offer.type === "sell") {
          if (buyer.money < offer.price) throw "Not enough money";
          buyer.money -= offer.price;
          buyer.inventory[item] = (buyer.inventory[item] || 0) + offer.quantity;
          seller.money += offer.price;
          seller.inventory[item] -= offer.quantity;
        } else {
          if (seller.inventory[item] < offer.quantity) throw "Not enough stock";
          if (buyer.money < offer.price) throw "Not enough money";
          buyer.money -= offer.price;
          buyer.inventory[item] = (buyer.inventory[item] || 0) + offer.quantity;
          seller.money += offer.price;
          seller.inventory[item] -= offer.quantity;
        }

        transaction.update(buyerRef, buyer);
        transaction.update(sellerRef, seller);
        transaction.delete(offerRef);
      });
    }

    /* ---------------- Create Offer ---------------- */
    document.getElementById("create-offer-btn").addEventListener("click", () => {
      offerModal.classList.remove("hidden");
      offerModal.classList.add("flex");
    });

    cancelOfferBtn.addEventListener("click", () => {
      offerModal.classList.add("hidden");
      offerModal.classList.remove("flex");
    });

    submitOfferBtn.addEventListener("click", async () => {
      const item = offerItem.value.trim();
      const qty = parseInt(offerQuantity.value, 10);
      const price = parseFloat(offerPrice.value);
      const type = offerType.value;

      if (!item || qty <= 0 || price <= 0) return;

      // Commission is charged here (non-refundable if canceled)
      const commission = Math.ceil(price * 0.1);

      const offerData = {
        userId: currentUserId,
        item,
        quantity: qty,
        price,
        type,
        commission,
        createdAt: new Date()
      };

      await addDoc(collection(db, "offers"), offerData);

      offerModal.classList.add("hidden");
      offerModal.classList.remove("flex");
      offerItem.value = "";
      offerQuantity.value = "";
      offerPrice.value = "";
    });

    /* ---------------- Ranking ---------------- */
    let currentSort = "money";
    document.getElementById("sort-money").addEventListener("click", () => {
      currentSort = "money";
      loadRanking();
    });
    document.getElementById("sort-xp").addEventListener("click", () => {
      currentSort = "xp";
      loadRanking();
    });

    function loadRanking() {
      const q = query(collection(db, "playerState"));
      onSnapshot(q, (snapshot) => {
        const players = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          players.push({
            nickname: data.nickname || docSnap.id.slice(0, 8),
            money: data.money ?? 0,
            xp: data.xp ?? 0
          });
        });

        players.sort((a, b) => b[currentSort] - a[currentSort]);
        rankingList.innerHTML = "";
        players.forEach((p) => {
          const li = document.createElement("li");
          li.textContent = `${p.nickname} - $${p.money} - XP ${p.xp}`;
          rankingList.appendChild(li);
        });
      });
    }

  </script>
</body>
</html>
