<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Demand Rusher - Item Manager</title>
<script type="module" src="../shared/firebase_config.js"></script>
<link href="https://cdn.tailwindcss.com" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #2c2f33; color: #dcdcdc; }
  .container-panel { background-color: #40444b; border-radius: 8px; padding: 16px; }
  .hover-row:hover { background-color: #4a4d53; transition: 0.2s; }
</style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

<!-- Navbar Placeholder -->
<div id="navbar"></div>

<main class="w-full max-w-6xl mt-6 space-y-6">

  <h1 class="text-3xl font-bold text-[#7289da]">Gamemaster - Item Manager</h1>

  <!-- Add / Edit Item Form -->
  <div class="container-panel">
    <h2 class="text-xl font-semibold mb-4">Add / Edit Item</h2>
    <form id="item-form" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="item-name" placeholder="Item Name" class="p-2 rounded bg-gray-700 border border-gray-600" required>
        <input type="text" id="item-group" placeholder="Group" class="p-2 rounded bg-gray-700 border border-gray-600" required>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="number" id="item-weight" placeholder="Weight" class="p-2 rounded bg-gray-700 border border-gray-600" required>
        <input type="number" id="crafting-time" placeholder="Crafting Time (seconds)" class="p-2 rounded bg-gray-700 border border-gray-600">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select id="required-tool" class="p-2 rounded bg-gray-700 border border-gray-600">
          <option value="">Select Required Tool</option>
        </select>
      </div>
      <!-- Crafting parents -->
      <div>
        <label class="block mb-1">Parents / Ingredients (select + quantity)</label>
        <div id="parents-container" class="space-y-2"></div>
        <button type="button" id="add-parent-btn" class="mt-2 bg-blue-600 p-2 rounded hover:bg-blue-500">Add Parent</button>
      </div>
      <button type="submit" class="bg-green-600 p-2 rounded hover:bg-green-500 w-full mt-2">Save Item</button>
    </form>
    <p id="form-error" class="text-red-500 mt-2"></p>
  </div>

  <!-- Item List -->
  <div class="container-panel">
    <h2 class="text-xl font-semibold mb-4">Existing Items</h2>
    <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
      <input type="text" id="search-name" placeholder="Search by Name" class="p-2 rounded bg-gray-700 border border-gray-600 flex-1">
      <select id="filter-group" class="p-2 rounded bg-gray-700 border border-gray-600">
        <option value="">All Groups</option>
      </select>
    </div>
    <div id="items-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
  </div>

</main>

<script type="module">
import { auth, db } from "../shared/firebase_config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const itemForm = document.getElementById('item-form');
const itemName = document.getElementById('item-name');
const itemGroup = document.getElementById('item-group');
const itemWeight = document.getElementById('item-weight');
const craftingTime = document.getElementById('crafting-time');
const requiredTool = document.getElementById('required-tool');
const parentsContainer = document.getElementById('parents-container');
const addParentBtn = document.getElementById('add-parent-btn');
const formError = document.getElementById('form-error');
const itemsList = document.getElementById('items-list');
const searchName = document.getElementById('search-name');
const filterGroup = document.getElementById('filter-group');

let editItemId = null;
let allItems = [];

// Helper to create parent input row
function createParentRow(parentData = {}) {
  const div = document.createElement('div');
  div.className = "flex space-x-2 items-center";
  div.innerHTML = `
    <select class="parent-item p-2 rounded bg-gray-700 border border-gray-600 flex-1"></select>
    <input type="number" class="parent-quantity p-2 rounded bg-gray-700 border border-gray-600 w-24" placeholder="Qty" value="${parentData.qty || 1}">
    <input type="number" class="parent-byproduct p-2 rounded bg-gray-700 border border-gray-600 w-24" placeholder="Byproduct" value="${parentData.byproduct || 1}">
    <button type="button" class="remove-parent-btn bg-red-600 px-2 rounded hover:bg-red-500">X</button>
  `;
  const removeBtn = div.querySelector('.remove-parent-btn');
  removeBtn.addEventListener('click', ()=> div.remove());
  parentsContainer.appendChild(div);
  populateParentDropdown(div.querySelector('.parent-item'));
  if(parentData.itemId) div.querySelector('.parent-item').value = parentData.itemId;
}

// Populate parent dropdown
async function populateParentDropdown(selectEl) {
  const itemsSnap = await getDocs(collection(db,'artifacts/demandrusher_1.0.0/items'));
  selectEl.innerHTML = '<option value="">Select Parent</option>';
  itemsSnap.forEach(doc => {
    const data = doc.data();
    const option = document.createElement('option');
    option.value = doc.id;
    option.textContent = data.name;
    selectEl.appendChild(option);
  });
}

// Populate required tool dropdown
async function populateToolDropdown() {
  const itemsSnap = await getDocs(collection(db,'artifacts/demandrusher_1.0.0/items'));
  requiredTool.innerHTML = '<option value="">Select Required Tool</option>';
  itemsSnap.forEach(doc => {
    const data = doc.data();
    if(data.group === 'Tools'){
      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = data.name;
      requiredTool.appendChild(option);
    }
  });
}

// Fetch all items
async function fetchItems() {
  const itemsSnap = await getDocs(collection(db,'artifacts/demandrusher_1.0.0/items'));
  allItems = [];
  filterGroup.innerHTML = '<option value="">All Groups</option>';
  const groupsSet = new Set();
  itemsSnap.forEach(doc => {
    const data = doc.data();
    allItems.push({id: doc.id, ...data});
    groupsSet.add(data.group);
  });
  groupsSet.forEach(g => {
    const option = document.createElement('option');
    option.value = g;
    option.textContent = g;
    filterGroup.appendChild(option);
  });
  renderItems();
}

// Render items
function renderItems() {
  const nameFilter = searchName.value.toLowerCase();
  const groupFilter = filterGroup.value;
  itemsList.innerHTML = '';
  const filtered = allItems.filter(i=>{
    return (i.name.toLowerCase().includes(nameFilter)) &&
           (groupFilter === '' || i.group === groupFilter);
  });
  filtered.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'hover-row flex justify-between p-2 bg-gray-700 rounded';
    div.innerHTML = `
      <span>${item.name} (${item.group})</span>
      <div class="space-x-2">
        <button class="edit-btn bg-blue-600 px-2 rounded hover:bg-blue-500">Edit</button>
        <button class="delete-btn bg-red-600 px-2 rounded hover:bg-red-500">Delete</button>
      </div>
    `;
    div.querySelector('.edit-btn').addEventListener('click', ()=>loadItemForEdit(item));
    div.querySelector('.delete-btn').addEventListener('click', ()=>deleteItem(item.id));
    itemsList.appendChild(div);
  });
}

// Load item data for edit
function loadItemForEdit(item) {
  editItemId = item.id;
  itemName.value = item.name;
  itemGroup.value = item.group;
  itemWeight.value = item.weight;
  craftingTime.value = item.craftingTime || '';
  requiredTool.value = item.tool || '';
  parentsContainer.innerHTML = '';
  if(item.parents){
    item.parents.forEach(p=>createParentRow(p));
  }
}

// Delete item
async function deleteItem(id) {
  if(confirm('Are you sure you want to delete this item?')){
    await deleteDoc(doc(db,'artifacts/demandrusher_1.0.0/items',id));
    fetchItems();
  }
}

// Submit form
itemForm.addEventListener('submit', async e=>{
  e.preventDefault();
  formError.textContent = '';
  if(!itemName.value || !itemGroup.value || !itemWeight.value) { formError.textContent='Fill all required fields'; return; }
  const parents = [];
  parentsContainer.querySelectorAll('.flex').forEach(row=>{
    const itemId = row.querySelector('.parent-item').value;
    const qty = parseFloat(row.querySelector('.parent-quantity').value);
    const byproduct = parseFloat(row.querySelector('.parent-byproduct').value);
    if(itemId) parents.push({itemId, qty, byproduct});
  });
  const data = {
    name: itemName.value,
    group: itemGroup.value,
    weight: parseFloat(itemWeight.value),
    craftingTime: parseFloat(craftingTime.value)||0,
    tool: requiredTool.value || '',
    parents
  };
  if(editItemId){
    await updateDoc(doc(db,'artifacts/demandrusher_1.0.0/items',editItemId),data);
    editItemId=null;
  }else{
    await addDoc(collection(db,'artifacts/demandrusher_1.0.0/items'),data);
  }
  itemForm.reset();
  parentsContainer.innerHTML='';
  fetchItems();
});

// Add parent button
addParentBtn.addEventListener('click', ()=>createParentRow());

// Filters
searchName.addEventListener('input', renderItems);
filterGroup.addEventListener('change', renderItems);

// Populate tool dropdown & fetch items on load
populateToolDropdown();
fetchItems();

// Auth check
onAuthStateChanged(auth,user=>{
  if(!user) window.location.href='../login.html';
});
</script>

<script>
  // Load navbar
  fetch("../shared/navbar.html")
    .then(res=>res.text())
    .then(data=>document.getElementById("navbar").innerHTML=data);
</script>

</body>
</html>
